# ä½¿ç”¨shell æ‰§è¡Œå™¨è¿›è¡Œæ„å»º
default:
  tags:
    - shell-runner

workflow:
  rules:
    # æ¨é€ä»£ç ä¸å¼€å§‹æ„å»º
    - if: '$CI_PIPELINE_SOURCE == "push"'
      when: never
    # æ‰‹åŠ¨æ„å»ºæ‰å¼€å§‹
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: always
    # é€šè¿‡ API è§¦å‘æ—¶å¼€å§‹æ„å»º
    - if: '$CI_PIPELINE_SOURCE == "api"'
      when: always

stages:
  - notify_start
  - build
  - deploy
  - notify_success
  - notify_failure

# æ„å»ºå¼€å§‹æ¶ˆæ¯é€šçŸ¥
notify_start:
  stage: notify_start
  script:
    - PIPELINE_URL="${CI_PROJECT_URL}/pipelines/${CI_PIPELINE_ID}"
    - >
      curl -X POST -H "Content-Type: application/json" -d "{\"msgtype\": \"markdown\", \"markdown\": {\"content\": \"<font color=\\\"info\\\">ã€$CI_PROJECT_NAMESPACE Â» $CI_PROJECT_NAMEã€‘</font>\\n >æ„å»º<font color=\\\"comment\\\">å¼€å§‹</font>\\n >æ„å»ºå‚æ•°ï¼š<font color=\\\"comment\\\">branch=${CI_COMMIT_REF_NAME} </font>\\n >[æŸ¥çœ‹æ§åˆ¶å°](${PIPELINE_URL})\"}}" $WEB_HOOK_URL

# æ„å»ºæˆåŠŸæ¶ˆæ¯é€šçŸ¥
notify_success:
  stage: notify_success
  rules:
    - when: on_success
  script:
    - PIPELINE_URL="${CI_PROJECT_URL}/pipelines/${CI_PIPELINE_ID}"
    - >
      curl -X POST -H "Content-Type: application/json" -d "{\"markdown\": {\"content\": \"<font color=\\\"info\\\">ã€$CI_PROJECT_NAMESPACE Â» $CI_PROJECT_NAMEã€‘</font>\\n >æ„å»º<font color=\\\"info\\\">æˆåŠŸ~</font>ğŸ‘\\n >[æŸ¥çœ‹æ§åˆ¶å°](${PIPELINE_URL})\"}, \"msgtype\": \"markdown\"}" $WEB_HOOK_URL

# æ„å»ºå¤±è´¥æ¶ˆæ¯é€šçŸ¥
notify_failure:
  stage: notify_failure
  rules:
    - when: on_failure
  script:
    - PIPELINE_URL="${CI_PROJECT_URL}/pipelines/${CI_PIPELINE_ID}"
    - >
      curl -X POST -H "Content-Type: application/json" -d "{\"markdown\": {\"content\": \"<font color=\\\"info\\\">ã€$CI_PROJECT_NAMESPACE Â» $CI_PROJECT_NAMEã€‘</font>\\n >æ„å»º<font color=\\\"warning\\\">å¼‚å¸¸</font>\\n >[æŸ¥çœ‹æ§åˆ¶å°](${PIPELINE_URL})\"}, \"msgtype\": \"markdown\"}" $WEB_HOOK_URL

# æ„å»º
build:
  stage: build
  rules:
    - when: on_success
  script:
    - export JAVA_HOME=/opt/module/java/java21
    - export PATH=$JAVA_HOME/bin:$PATH
    - java -version
    - mvn clean package
  artifacts:
    paths:
      - target/license.jar
    expire_in: 1 day

# éƒ¨ç½²
deploy:
 stage: deploy
 rules:
   - when: on_success
 script:
   - eval $(ssh-agent -s)
   - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
   - ssh -o StrictHostKeyChecking=no $USER@$HOST "cp /opt/module/license/license.jar /opt/module/license/license_$(date +\"%Y%m%d%H%M\").jar"
   - scp target/license.jar $USER@$HOST:/opt/module/license/license.jar
   - ssh -o StrictHostKeyChecking=no $USER@$HOST "/opt/module/license/startup.sh"